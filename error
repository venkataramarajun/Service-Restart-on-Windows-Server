@Library('shared-library') _  // Use this for shared libraries

pipeline {
    agent {
        node {
           label 'docker-build-aws'
        }
    }
    environment {
        JENKINS_TOKEN = credentials("pavani_jenkins_api_token")
    }
    stages {
        stage('Read YAML') {
            steps {
                script {
                    def filenames = getFileNames("User_Inputs/RestartRDS")
                    echo "YAML files found: ${filenames}"

                    filenames.each { yamlFilePath ->

                        // Debugging: Output the full contents of the YAML file
                        def yamlContent = readYaml(file: yamlFilePath)
                        echo "YAML file content: ${yamlContent}"

                        // Assuming extractSchedule reads the same data
                        def result = extractSchedule(yamlFilePath)
                        echo "Extracted result: ${result}"

                        def database_name = result?.db_name ?: "null"
                        def schedule = result?.schedule ?: "null"

                        // Debugging: Output extracted values
                        echo "Database name: ${database_name}, Schedule: ${schedule}"

                        // Ensure variables are not null
                        if (database_name == "null") {
                            error("Database name is missing in the YAML file: ${yamlFilePath}")
                        }

                        if (schedule == "null") {
                            error("Schedule is missing in the YAML file: ${yamlFilePath}")
                        }

                        // Proceed with job creation
                        createJob(schedule, "GHSSelfServicePlatform/AWS-RDS-Restart", "${database_name}-restart-schedule", JENKINS_TOKEN_USR, JENKINS_TOKEN_PSW)
                    }
                }
            }
        }
    }
}
